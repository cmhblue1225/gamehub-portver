<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread 'n Butter - ë¦¬ë“¬ ìš”ë¦¬ ê²Œì„</title>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- QR Code -->
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- SessionSDK -->
    <script src="/js/SessionSDK.js"></script>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #FFF4E6 0%, #FFE5B4 100%);
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
        }

        /* UI ì˜¤ë²„ë ˆì´ */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .ui-overlay > * {
            pointer-events: auto;
        }

        /* ìƒë‹¨ HUD */
        .top-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .score {
            background: rgba(255, 215, 0, 0.9);
            padding: 10px 20px;
            border-radius: 15px;
            color: #333;
        }

        .round {
            background: rgba(0, 150, 255, 0.9);
            padding: 10px 20px;
            border-radius: 15px;
        }

        .time {
            background: rgba(255, 100, 100, 0.9);
            padding: 10px 20px;
            border-radius: 15px;
        }

        /* ë¦¬ë“¬ ì¸ë””ì¼€ì´í„° */
        .rhythm-indicator {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .beat-target {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 4px solid #FFD700;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            left: 50%;
            transform: translateX(-50%);
        }

        .beat-note {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
            transition: transform 0.1s;
        }

        .beat-note.hit {
            transform: scale(1.5);
            opacity: 0;
        }

        /* í”¼ë“œë°± í…ìŠ¤íŠ¸ */
        .feedback-text {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            animation: fadeOut 0.5s;
            pointer-events: none;
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        /* í”Œë ˆì´ì–´ ìƒíƒœ */
        .player-status {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 14px;
        }

        .player-item.active {
            background: rgba(76, 175, 80, 0.3);
            border-left: 3px solid #4CAF50;
        }

        /* ë©”ë‰´ í™”ë©´ */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .menu-screen.hidden {
            display: none;
        }

        .menu-title {
            font-size: 72px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .menu-subtitle {
            font-size: 24px;
            color: #fff;
            margin-bottom: 40px;
        }

        .difficulty-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .difficulty-btn {
            padding: 20px 40px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .difficulty-btn.easy {
            background: #4CAF50;
            color: white;
        }

        .difficulty-btn.normal {
            background: #FF9800;
            color: white;
        }

        .difficulty-btn.hard {
            background: #F44336;
            color: white;
        }

        .difficulty-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* QR ì½”ë“œ ì»¨í…Œì´ë„ˆ */
        .qr-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            display: none;
        }

        .qr-container.show {
            display: block;
        }

        .qr-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .session-code {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            letter-spacing: 5px;
        }

        /* ê²°ê³¼ í™”ë©´ */
        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .result-screen.show {
            display: flex;
        }

        .result-title {
            font-size: 64px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 30px;
        }

        .final-score {
            font-size: 48px;
            color: #fff;
            margin-bottom: 20px;
        }

        .chef-rank {
            font-size: 72px;
            margin-bottom: 30px;
        }

        .accuracy {
            font-size: 32px;
            color: #4CAF50;
            margin-bottom: 40px;
        }

        .restart-btn {
            padding: 20px 60px;
            font-size: 28px;
            font-weight: bold;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
    <!-- ë©”ë‰´ í™”ë©´ -->
    <div class="menu-screen" id="menuScreen">
        <div class="menu-title">ğŸ§ˆ Spread 'n Butter</div>
        <div class="menu-subtitle">ë¦¬ë“¬ì— ë§ì¶° ë²„í„°ë¥¼ ë°”ë¥´ì„¸ìš”!</div>

        <div class="difficulty-buttons">
            <button class="difficulty-btn easy" onclick="game.selectDifficulty('easy')">
                ğŸ˜Š Easy<br><small>BPM 100</small>
            </button>
            <button class="difficulty-btn normal" onclick="game.selectDifficulty('normal')">
                ğŸ˜ Normal<br><small>BPM 120</small>
            </button>
            <button class="difficulty-btn hard" onclick="game.selectDifficulty('hard')">
                ğŸ˜ˆ Hard<br><small>BPM 150</small>
            </button>
        </div>

        <div class="qr-container" id="qrContainer">
            <div class="qr-title">ğŸ“± í•¸ë“œí°ìœ¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</div>
            <div class="session-code" id="sessionCode">------</div>
            <div id="qrCode"></div>
            <div style="margin-top: 20px; color: #666;">
                ëŒ€ê¸° ì¤‘ì¸ í”Œë ˆì´ì–´: <span id="playerCount">0</span> / 4
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
    <canvas id="gameCanvas"></canvas>

    <!-- UI ì˜¤ë²„ë ˆì´ -->
    <div class="ui-overlay">
        <div class="top-hud">
            <div class="score">Score: <span id="scoreText">0</span></div>
            <div class="round">Round <span id="roundText">1</span>/3</div>
            <div class="time">Time: <span id="timeText">0.0</span>s</div>
        </div>

        <div class="player-status" id="playerStatus"></div>

        <div class="rhythm-indicator" id="rhythmIndicator" style="display: none;">
            <div class="beat-target"></div>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div class="result-screen" id="resultScreen">
        <div class="result-title">Game Over!</div>
        <div class="final-score">Score: <span id="finalScore">0</span></div>
        <div class="chef-rank" id="chefRank">â­â­â­</div>
        <div class="accuracy">Accuracy: <span id="finalAccuracy">0</span>%</div>
        <button class="restart-btn" onclick="game.restart()">ğŸ”„ Play Again</button>
    </div>

    <script>
        // ê²Œì„ ì„¤ì •
        const DIFFICULTY_CONFIG = {
            easy: {
                bpm: 100,
                beatInterval: 600,
                perfectWindow: 150,
                goodWindow: 300,
                shakeThreshold: 15
            },
            normal: {
                bpm: 120,
                beatInterval: 500,
                perfectWindow: 100,
                goodWindow: 250,
                shakeThreshold: 20
            },
            hard: {
                bpm: 150,
                beatInterval: 400,
                perfectWindow: 80,
                goodWindow: 200,
                shakeThreshold: 25
            }
        };

        // ë©”ì¸ ê²Œì„ í´ë˜ìŠ¤
        class SpreadNButterGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                // SDK ì´ˆê¸°í™”
                this.sdk = new SessionSDK({
                    gameId: 'spread-n-butter',
                    gameType: 'multi',
                    debug: true
                });

                // ê²Œì„ ìƒíƒœ
                this.state = {
                    connected: false,
                    difficulty: null,
                    playing: false,
                    score: 0,
                    round: 1,
                    maxRounds: 3,
                    time: 0,
                    beatCount: 0,
                    perfectHits: 0,
                    goodHits: 0,
                    misses: 0,
                    butterSpread: 0  // 0~1
                };

                // í”Œë ˆì´ì–´ ë°ì´í„°
                this.players = new Map();
                this.playerColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];

                // 3D ì‹œìŠ¤í…œ
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.models = {};

                // ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ
                this.audioContext = null;
                this.beatTimer = null;

                // ë¦¬ë“¬ ë…¸íŠ¸
                this.notes = [];

                this.setupSDK();
                this.init3DScene();
                this.setupAudio();

                // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬
                window.addEventListener('resize', () => this.onResize());
            }

            setupSDK() {
                // ì„œë²„ ì—°ê²°
                this.sdk.on('connected', async () => {
                    console.log('âœ… ì„œë²„ ì—°ê²° ì™„ë£Œ');
                    this.state.connected = true;
                });

                // ì„¸ì…˜ ìƒì„±
                this.sdk.on('session-created', (event) => {
                    const session = event.detail || event;
                    console.log('âœ… ì„¸ì…˜ ìƒì„±:', session.sessionCode);

                    document.getElementById('sessionCode').textContent = session.sessionCode;

                    // QR ì½”ë“œ ìƒì„±
                    const sensorUrl = `${window.location.origin}/sensor.html?session=${session.sessionCode}`;
                    QRCodeGenerator.generateElement(sensorUrl, 200)
                        .then(qrElement => {
                            const container = document.getElementById('qrCode');
                            container.innerHTML = '';
                            container.appendChild(qrElement);
                        })
                        .catch(err => {
                            console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', err);
                            document.getElementById('qrCode').innerHTML =
                                `<p style="font-size: 12px; color: #666;">${sensorUrl}</p>`;
                        });
                });

                // ì„¼ì„œ ì—°ê²°
                this.sdk.on('sensor-connected', (event) => {
                    const data = event.detail || event;
                    console.log('ğŸ“± í”Œë ˆì´ì–´ ì—°ê²°:', data);

                    const playerId = data.deviceId || data.id || `player-${this.players.size + 1}`;
                    const playerNumber = this.players.size + 1;

                    this.players.set(playerId, {
                        id: playerId,
                        number: playerNumber,
                        color: this.playerColors[playerNumber - 1],
                        shakeIntensity: 0,
                        tilt: { x: 0, y: 0 },
                        lastShakeTime: 0,
                        score: 0,
                        accuracy: 0
                    });

                    this.updatePlayerStatus();
                    document.getElementById('playerCount').textContent = this.players.size;

                    // 1ëª… ì´ìƒ ì—°ê²°ë˜ë©´ ê²Œì„ ì‹œì‘ ê°€ëŠ¥
                    if (this.players.size >= 1 && !this.state.playing) {
                        setTimeout(() => this.startGame(), 2000);
                    }
                });

                // ì„¼ì„œ ë°ì´í„° ìˆ˜ì‹ 
                this.sdk.on('sensor-data', (event) => {
                    const sensorData = event.detail || event;
                    this.processSensorData(sensorData);
                });

                // ì„¼ì„œ ì—°ê²° í•´ì œ
                this.sdk.on('sensor-disconnected', (event) => {
                    const data = event.detail || event;
                    const playerId = data.deviceId || data.id;
                    this.players.delete(playerId);
                    this.updatePlayerStatus();
                    document.getElementById('playerCount').textContent = this.players.size;
                });
            }

            processSensorData(sensorData) {
                if (!sensorData || !sensorData.data) return;

                const playerId = sensorData.deviceId || sensorData.id || 'player-1';
                const player = this.players.get(playerId);
                if (!player) return;

                const data = sensorData.data;
                const config = DIFFICULTY_CONFIG[this.state.difficulty];

                // ê°€ì†ë„ í¬ê¸° ê³„ì‚°
                const accelMagnitude = Math.sqrt(
                    Math.pow(data.acceleration.x || 0, 2) +
                    Math.pow(data.acceleration.y || 0, 2) +
                    Math.pow(data.acceleration.z || 0, 2)
                );

                // í”ë“¤ê¸° ê°ì§€
                if (accelMagnitude > config.shakeThreshold) {
                    const now = Date.now();
                    if (now - player.lastShakeTime > 200) {  // ë””ë°”ìš´ìŠ¤
                        player.lastShakeTime = now;
                        this.onPlayerShake(player, accelMagnitude);
                    }
                }

                // ê¸°ìš¸ê¸° ë§¤í•‘
                player.tilt.x = data.orientation.gamma || 0;  // -90~90
                player.tilt.y = data.orientation.beta || 0;   // -180~180

                // í”ë“¤ê¸° ê°•ë„ ê°ì†Œ (ìì—°ìŠ¤ëŸ¬ìš´ ê°ì‡ )
                player.shakeIntensity = Math.max(0, player.shakeIntensity - 0.01);

                this.updatePlayerStatus();
            }

            onPlayerShake(player, magnitude) {
                if (!this.state.playing) return;

                // í”ë“¤ê¸° ê°•ë„ ì¦ê°€
                player.shakeIntensity = Math.min(1, player.shakeIntensity + 0.2);

                // íƒ€ì´ë° ì²´í¬
                const timing = this.checkBeatTiming();

                if (timing.rating === 'PERFECT') {
                    this.state.perfectHits++;
                    this.state.score += 200;
                    player.score += 200;
                    this.showFeedback('Perfect! ğŸŒŸ', '#FFD700');
                    this.playSound('perfect');
                } else if (timing.rating === 'GOOD') {
                    this.state.goodHits++;
                    this.state.score += 100;
                    player.score += 100;
                    this.showFeedback('Good! âœ¨', '#4ECDC4');
                    this.playSound('good');
                } else {
                    this.state.misses++;
                    this.showFeedback('Miss...', '#FF6B6B');
                }

                // ë²„í„° í¼ì§€ê¸°
                this.state.butterSpread = Math.min(1, this.state.butterSpread + 0.05);
                this.updateBreadTexture();

                this.updateUI();
            }

            checkBeatTiming() {
                const config = DIFFICULTY_CONFIG[this.state.difficulty];
                const now = performance.now();
                const beatTime = (now % config.beatInterval) / config.beatInterval;

                // 0 ë˜ëŠ” 1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì •ë°•
                const timingError = Math.min(beatTime, 1 - beatTime) * config.beatInterval;

                if (timingError < config.perfectWindow) {
                    return { rating: 'PERFECT', multiplier: 2.0 };
                } else if (timingError < config.goodWindow) {
                    return { rating: 'GOOD', multiplier: 1.5 };
                } else {
                    return { rating: 'MISS', multiplier: 1.0 };
                }
            }

            showFeedback(text, color) {
                const feedback = document.createElement('div');
                feedback.className = 'feedback-text';
                feedback.textContent = text;
                feedback.style.color = color;
                document.body.appendChild(feedback);

                setTimeout(() => feedback.remove(), 500);
            }

            updatePlayerStatus() {
                const container = document.getElementById('playerStatus');
                container.innerHTML = '<h3 style="margin-bottom: 10px;">ğŸ‘¥ Players</h3>';

                this.players.forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player-item active';
                    div.style.borderColor = player.color;
                    div.innerHTML = `
                        <div style="color: ${player.color};">Player ${player.number}</div>
                        <div>Score: ${player.score}</div>
                        <div>Shake: ${(player.shakeIntensity * 100).toFixed(0)}%</div>
                    `;
                    container.appendChild(div);
                });
            }

            updateUI() {
                document.getElementById('scoreText').textContent = this.state.score;
                document.getElementById('roundText').textContent = this.state.round;
                document.getElementById('timeText').textContent = this.state.time.toFixed(1);
            }

            selectDifficulty(difficulty) {
                this.state.difficulty = difficulty;
                console.log('ë‚œì´ë„ ì„ íƒ:', difficulty.toUpperCase());

                // QR ì»¨í…Œì´ë„ˆ í‘œì‹œ
                document.getElementById('qrContainer').classList.add('show');

                // ì„¸ì…˜ ìƒì„±
                this.sdk.createSession();
            }

            async startGame() {
                if (this.players.size === 0) {
                    alert('í”Œë ˆì´ì–´ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                    return;
                }

                console.log('ğŸ® ê²Œì„ ì‹œì‘!');
                this.state.playing = true;

                // ë©”ë‰´ ìˆ¨ê¸°ê¸°
                document.getElementById('menuScreen').classList.add('hidden');

                // ë¦¬ë“¬ ì¸ë””ì¼€ì´í„° í‘œì‹œ
                document.getElementById('rhythmIndicator').style.display = 'flex';

                // 3D ëª¨ë¸ ë¡œë”©
                await this.load3DModels();

                // ì¹´ìš´íŠ¸ë‹¤ìš´
                await this.countdown();

                // ê²Œì„ ì‹œì‘
                this.startRound();
            }

            async countdown() {
                const counts = ['3', '2', '1', 'Start!'];
                for (const count of counts) {
                    this.showFeedback(count, '#FFD700');
                    this.playSound('beat');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            startRound() {
                const config = DIFFICULTY_CONFIG[this.state.difficulty];

                // ë¦¬ë“¬ íƒ€ì´ë¨¸ ì‹œì‘
                let lastBeatTime = performance.now();
                this.beatTimer = setInterval(() => {
                    this.onBeat();
                    lastBeatTime = performance.now();
                }, config.beatInterval);

                // ê²Œì„ íƒ€ì´ë¨¸
                this.gameTimer = setInterval(() => {
                    this.state.time += 0.1;
                    this.updateUI();

                    // 30ì´ˆ í›„ ë¼ìš´ë“œ ì¢…ë£Œ
                    if (this.state.time >= 30) {
                        this.endRound();
                    }
                }, 100);

                // ë Œë” ë£¨í”„
                this.animate();
            }

            onBeat() {
                this.state.beatCount++;

                // ë¹„ì£¼ì–¼ í”¼ë“œë°±
                this.flashBeatIndicator();

                // ë¹„íŠ¸ ì‚¬ìš´ë“œ
                this.playSound('beat');

                // ë¦¬ë“¬ ë…¸íŠ¸ ìƒì„±
                this.createBeatNote();
            }

            flashBeatIndicator() {
                const target = document.querySelector('.beat-target');
                target.style.background = 'rgba(255, 215, 0, 0.8)';
                setTimeout(() => {
                    target.style.background = 'rgba(255, 215, 0, 0.3)';
                }, 100);
            }

            createBeatNote() {
                const container = document.getElementById('rhythmIndicator');
                const note = document.createElement('div');
                note.className = 'beat-note';
                note.style.right = '-40px';
                container.appendChild(note);

                // ì• ë‹ˆë©”ì´ì…˜
                let position = -40;
                const animate = () => {
                    position += 5;
                    note.style.right = `${position}px`;

                    if (position < 600) {
                        requestAnimationFrame(animate);
                    } else {
                        note.remove();
                    }
                };
                animate();
            }

            endRound() {
                clearInterval(this.beatTimer);
                clearInterval(this.gameTimer);

                if (this.state.round < this.state.maxRounds) {
                    // ë‹¤ìŒ ë¼ìš´ë“œ
                    this.state.round++;
                    this.state.time = 0;
                    setTimeout(() => this.startRound(), 3000);
                } else {
                    // ê²Œì„ ì¢…ë£Œ
                    this.endGame();
                }
            }

            endGame() {
                this.state.playing = false;

                // ì •í™•ë„ ê³„ì‚°
                const totalHits = this.state.perfectHits + this.state.goodHits + this.state.misses;
                const accuracy = totalHits > 0
                    ? ((this.state.perfectHits * 2 + this.state.goodHits) / (totalHits * 2) * 100)
                    : 0;

                // Chef Rank ê³„ì‚°
                let rank = '';
                if (accuracy >= 90) rank = 'â­â­â­â­â­';
                else if (accuracy >= 75) rank = 'â­â­â­â­';
                else if (accuracy >= 60) rank = 'â­â­â­';
                else if (accuracy >= 40) rank = 'â­â­';
                else rank = 'â­';

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('finalScore').textContent = this.state.score;
                document.getElementById('chefRank').textContent = rank;
                document.getElementById('finalAccuracy').textContent = accuracy.toFixed(1);
                document.getElementById('resultScreen').classList.add('show');

                // ë¦¬ë“¬ ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
                document.getElementById('rhythmIndicator').style.display = 'none';
            }

            restart() {
                // ìƒíƒœ ì´ˆê¸°í™”
                this.state.score = 0;
                this.state.round = 1;
                this.state.time = 0;
                this.state.beatCount = 0;
                this.state.perfectHits = 0;
                this.state.goodHits = 0;
                this.state.misses = 0;
                this.state.butterSpread = 0;

                // í”Œë ˆì´ì–´ ì ìˆ˜ ì´ˆê¸°í™”
                this.players.forEach(player => {
                    player.score = 0;
                    player.shakeIntensity = 0;
                });

                // UI ì´ˆê¸°í™”
                document.getElementById('resultScreen').classList.remove('show');
                document.getElementById('menuScreen').classList.remove('hidden');
                document.getElementById('qrContainer').classList.remove('show');

                this.updateUI();
                this.updatePlayerStatus();
            }

            // ===== 3D ì‹œìŠ¤í…œ =====

            init3DScene() {
                // ì”¬ ìƒì„±
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);

                // ì¹´ë©”ë¼
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(0, 3, 5);
                this.camera.lookAt(0, 0, 0);

                // ë Œë”ëŸ¬
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;

                // ì¡°ëª…
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);

                const pointLight = new THREE.PointLight(0xFFD700, 0.5);
                pointLight.position.set(0, 5, 0);
                this.scene.add(pointLight);
            }

            async load3DModels() {
                const loader = new THREE.GLTFLoader();

                try {
                    // ë¹µ ë¡œë”©
                    const bread = await this.loadModel(loader, 'assets/models/bread-slice.glb');
                    bread.scale.set(2, 2, 2);
                    bread.position.set(0, 0, 0);
                    bread.rotation.x = -Math.PI / 2;
                    this.scene.add(bread);
                    this.models.bread = bread;

                    // ë²„í„° ë¡œë”©
                    const butter = await this.loadModel(loader, 'assets/models/butter-block.glb');
                    butter.scale.set(0.8, 0.8, 0.8);
                    butter.position.set(0, 2, 2);
                    this.scene.add(butter);
                    this.models.butter = butter;

                    // ë‚˜ì´í”„ ë¡œë”©
                    const knife = await this.loadModel(loader, 'assets/models/butter-knife.glb');
                    knife.scale.set(1, 1, 1);
                    knife.position.set(-2, 1, 0);
                    knife.rotation.z = Math.PI / 4;
                    this.scene.add(knife);
                    this.models.knife = knife;

                    console.log('âœ… 3D ëª¨ë¸ ë¡œë”© ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ 3D ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:', error);
                }
            }

            loadModel(loader, url) {
                return new Promise((resolve, reject) => {
                    loader.load(
                        url,
                        (gltf) => resolve(gltf.scene),
                        undefined,
                        (error) => reject(error)
                    );
                });
            }

            updateBreadTexture() {
                // ë²„í„°ê°€ í¼ì§„ ì •ë„ì— ë”°ë¼ ë¹µ ìƒ‰ìƒ ë³€ê²½ (ê°„ë‹¨í•œ êµ¬í˜„)
                if (this.models.bread) {
                    const yellowIntensity = this.state.butterSpread;
                    this.models.bread.traverse((child) => {
                        if (child.isMesh && child.material) {
                            child.material.emissive = new THREE.Color(
                                yellowIntensity * 0.5,
                                yellowIntensity * 0.4,
                                0
                            );
                        }
                    });
                }
            }

            animate() {
                if (!this.state.playing) return;

                requestAnimationFrame(() => this.animate());

                // ë²„í„° íšŒì „
                if (this.models.butter) {
                    this.models.butter.rotation.y += 0.01;
                }

                // ë‚˜ì´í”„ ì• ë‹ˆë©”ì´ì…˜ (í”Œë ˆì´ì–´ ê¸°ìš¸ê¸°ì— ë”°ë¼)
                if (this.models.knife && this.players.size > 0) {
                    const firstPlayer = this.players.values().next().value;
                    if (firstPlayer) {
                        this.models.knife.rotation.z = (firstPlayer.tilt.x / 90) * (Math.PI / 4);
                    }
                }

                this.renderer.render(this.scene, this.camera);
            }

            onResize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                if (this.camera) {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                }

                if (this.renderer) {
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            }

            // ===== ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ =====

            setupAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            playSound(type) {
                if (!this.audioContext) return;

                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                switch (type) {
                    case 'beat':
                        oscillator.frequency.value = 440;  // A4
                        gainNode.gain.setValueAtTime(0.1, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.start(now);
                        oscillator.stop(now + 0.1);
                        break;

                    case 'perfect':
                        oscillator.frequency.value = 880;  // A5
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        oscillator.start(now);
                        oscillator.stop(now + 0.3);
                        break;

                    case 'good':
                        oscillator.frequency.value = 660;  // E5
                        gainNode.gain.setValueAtTime(0.15, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                        break;
                }
            }
        }

        // ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const game = new SpreadNButterGame();

        console.log('ğŸ§ˆ Spread \'n Butter ê²Œì„ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    </script>
</body>
</html>
